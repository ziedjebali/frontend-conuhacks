{"version":3,"file":"rematch-loading.esm.js","sources":["../src/index.ts"],"sourcesContent":["import { Model, Plugin } from '@rematch/core'\n\nexport interface LoadingConfig {\n\tname?: string\n\twhitelist?: string[]\n\tblacklist?: string[]\n\tasNumber?: boolean\n}\n\nconst cntState = {\n\tglobal: 0,\n\tmodels: {},\n\teffects: {},\n}\n\nconst createLoadingAction = (converter, i) => (\n\tstate,\n\t{ name, action }: any\n) => {\n\tcntState.global += i\n\tcntState.models[name] += i\n\tcntState.effects[name][action] += i\n\n\treturn {\n\t\t...state,\n\t\tglobal: converter(cntState.global),\n\t\tmodels: {\n\t\t\t...state.models,\n\t\t\t[name]: converter(cntState.models[name]),\n\t\t},\n\t\teffects: {\n\t\t\t...state.effects,\n\t\t\t[name]: {\n\t\t\t\t...state.effects[name],\n\t\t\t\t[action]: converter(cntState.effects[name][action]),\n\t\t\t},\n\t\t},\n\t}\n}\n\nconst validateConfig = config => {\n\tif (config.name && typeof config.name !== 'string') {\n\t\tthrow new Error('loading plugin config name must be a string')\n\t}\n\tif (config.asNumber && typeof config.asNumber !== 'boolean') {\n\t\tthrow new Error('loading plugin config asNumber must be a boolean')\n\t}\n\tif (config.whitelist && !Array.isArray(config.whitelist)) {\n\t\tthrow new Error(\n\t\t\t'loading plugin config whitelist must be an array of strings'\n\t\t)\n\t}\n\tif (config.blacklist && !Array.isArray(config.blacklist)) {\n\t\tthrow new Error(\n\t\t\t'loading plugin config blacklist must be an array of strings'\n\t\t)\n\t}\n\tif (config.whitelist && config.blacklist) {\n\t\tthrow new Error(\n\t\t\t'loading plugin config cannot have both a whitelist & a blacklist'\n\t\t)\n\t}\n}\n\nexport default (config: LoadingConfig = {}): Plugin => {\n\tvalidateConfig(config)\n\n\tconst loadingModelName = config.name || 'loading'\n\n\tconst converter =\n\t\tconfig.asNumber === true ? (cnt: number) => cnt : (cnt: number) => cnt > 0\n\n\tconst loading: Model = {\n\t\tname: loadingModelName,\n\t\treducers: {\n\t\t\thide: createLoadingAction(converter, -1),\n\t\t\tshow: createLoadingAction(converter, 1),\n\t\t},\n\t\tstate: {\n\t\t\t...cntState,\n\t\t},\n\t}\n\n\tcntState.global = 0\n\tloading.state.global = converter(cntState.global)\n\n\treturn {\n\t\tconfig: {\n\t\t\tmodels: {\n\t\t\t\tloading,\n\t\t\t},\n\t\t},\n\t\tonModel({ name }: Model) {\n\t\t\t// do not run dispatch on \"loading\" model\n\t\t\tif (name === loadingModelName) {\n\t\t\t\treturn\n\t\t\t}\n\n\t\t\tcntState.models[name] = 0\n\t\t\tloading.state.models[name] = converter(cntState.models[name])\n\t\t\tloading.state.effects[name] = {}\n\t\t\tconst modelActions = this.dispatch[name]\n\n\t\t\t// map over effects within models\n\t\t\tObject.keys(modelActions).forEach((action: string) => {\n\t\t\t\tif (this.dispatch[name][action].isEffect !== true) {\n\t\t\t\t\treturn\n\t\t\t\t}\n\n\t\t\t\tcntState.effects[name][action] = 0\n\t\t\t\tloading.state.effects[name][action] = converter(\n\t\t\t\t\tcntState.effects[name][action]\n\t\t\t\t)\n\n\t\t\t\tconst actionType = `${name}/${action}`\n\n\t\t\t\t// ignore items not in whitelist\n\t\t\t\tif (config.whitelist && !config.whitelist.includes(actionType)) {\n\t\t\t\t\treturn\n\t\t\t\t}\n\n\t\t\t\t// ignore items in blacklist\n\t\t\t\tif (config.blacklist && config.blacklist.includes(actionType)) {\n\t\t\t\t\treturn\n\t\t\t\t}\n\n\t\t\t\t// copy orig effect pointer\n\t\t\t\tconst origEffect = this.dispatch[name][action]\n\n\t\t\t\t// create function with pre & post loading calls\n\t\t\t\tconst effectWrapper = async (...props) => {\n\t\t\t\t\ttry {\n\t\t\t\t\t\tthis.dispatch.loading.show({ name, action })\n\t\t\t\t\t\t// waits for dispatch function to finish before calling \"hide\"\n\t\t\t\t\t\tconst effectResult = await origEffect(...props)\n\t\t\t\t\t\tthis.dispatch.loading.hide({ name, action })\n\t\t\t\t\t\treturn effectResult\n\t\t\t\t\t} catch (error) {\n\t\t\t\t\t\tthis.dispatch.loading.hide({ name, action })\n\t\t\t\t\t\tthrow error\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\teffectWrapper.isEffect = true\n\n\t\t\t\t// replace existing effect with new wrapper\n\t\t\t\tthis.dispatch[name][action] = effectWrapper\n\t\t\t})\n\t\t},\n\t}\n}\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AASA,IAAM,QAAQ,GAAG;IAChB,MAAM,EAAE,CAAC;IACT,MAAM,EAAE,EAAE;IACV,OAAO,EAAE,EAAE;CACX,CAAA;AAED,IAAM,mBAAmB,GAAG,UAAC,SAAS,EAAE,CAAC,IAAK,OAAA,UAC7C,KAAK,EACL,EAAqB;;QAAnB,cAAI,EAAE,kBAAM;IAEd,QAAQ,CAAC,MAAM,IAAI,CAAC,CAAA;IACpB,QAAQ,CAAC,MAAM,CAAC,IAAI,CAAC,IAAI,CAAC,CAAA;IAC1B,QAAQ,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC,MAAM,CAAC,IAAI,CAAC,CAAA;IAEnC,6BACI,KAAK,KACR,MAAM,EAAE,SAAS,CAAC,QAAQ,CAAC,MAAM,CAAC,EAClC,MAAM,wBACF,KAAK,CAAC,MAAM,gBACd,IAAI,IAAG,SAAS,CAAC,QAAQ,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC,QAEzC,OAAO,wBACH,KAAK,CAAC,OAAO,gBACf,IAAI,0BACD,KAAK,CAAC,OAAO,CAAC,IAAI,CAAC,gBACrB,MAAM,IAAG,SAAS,CAAC,QAAQ,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC,MAAM,CAAC,CAAC,gBAGrD;CACD,GAAA,CAAA;AAED,IAAM,cAAc,GAAG,UAAA,MAAM;IAC5B,IAAI,MAAM,CAAC,IAAI,IAAI,OAAO,MAAM,CAAC,IAAI,KAAK,QAAQ,EAAE;QACnD,MAAM,IAAI,KAAK,CAAC,6CAA6C,CAAC,CAAA;KAC9D;IACD,IAAI,MAAM,CAAC,QAAQ,IAAI,OAAO,MAAM,CAAC,QAAQ,KAAK,SAAS,EAAE;QAC5D,MAAM,IAAI,KAAK,CAAC,kDAAkD,CAAC,CAAA;KACnE;IACD,IAAI,MAAM,CAAC,SAAS,IAAI,CAAC,KAAK,CAAC,OAAO,CAAC,MAAM,CAAC,SAAS,CAAC,EAAE;QACzD,MAAM,IAAI,KAAK,CACd,6DAA6D,CAC7D,CAAA;KACD;IACD,IAAI,MAAM,CAAC,SAAS,IAAI,CAAC,KAAK,CAAC,OAAO,CAAC,MAAM,CAAC,SAAS,CAAC,EAAE;QACzD,MAAM,IAAI,KAAK,CACd,6DAA6D,CAC7D,CAAA;KACD;IACD,IAAI,MAAM,CAAC,SAAS,IAAI,MAAM,CAAC,SAAS,EAAE;QACzC,MAAM,IAAI,KAAK,CACd,kEAAkE,CAClE,CAAA;KACD;CACD,CAAA;AAED,aAAe,UAAC,MAA0B;IAA1B,uBAAA,EAAA,WAA0B;IACzC,cAAc,CAAC,MAAM,CAAC,CAAA;IAEtB,IAAM,gBAAgB,GAAG,MAAM,CAAC,IAAI,IAAI,SAAS,CAAA;IAEjD,IAAM,SAAS,GACd,MAAM,CAAC,QAAQ,KAAK,IAAI,GAAG,UAAC,GAAW,IAAK,OAAA,GAAG,GAAA,GAAG,UAAC,GAAW,IAAK,OAAA,GAAG,GAAG,CAAC,GAAA,CAAA;IAE3E,IAAM,OAAO,GAAU;QACtB,IAAI,EAAE,gBAAgB;QACtB,QAAQ,EAAE;YACT,IAAI,EAAE,mBAAmB,CAAC,SAAS,EAAE,CAAC,CAAC,CAAC;YACxC,IAAI,EAAE,mBAAmB,CAAC,SAAS,EAAE,CAAC,CAAC;SACvC;QACD,KAAK,eACD,QAAQ,CACX;KACD,CAAA;IAED,QAAQ,CAAC,MAAM,GAAG,CAAC,CAAA;IACnB,OAAO,CAAC,KAAK,CAAC,MAAM,GAAG,SAAS,CAAC,QAAQ,CAAC,MAAM,CAAC,CAAA;IAEjD,OAAO;QACN,MAAM,EAAE;YACP,MAAM,EAAE;gBACP,OAAO,SAAA;aACP;SACD;QACD,OAAO,EAAP,UAAQ,EAAe;YAAvB,iBAwDC;gBAxDS,cAAI;;YAEb,IAAI,IAAI,KAAK,gBAAgB,EAAE;gBAC9B,OAAM;aACN;YAED,QAAQ,CAAC,MAAM,CAAC,IAAI,CAAC,GAAG,CAAC,CAAA;YACzB,OAAO,CAAC,KAAK,CAAC,MAAM,CAAC,IAAI,CAAC,GAAG,SAAS,CAAC,QAAQ,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC,CAAA;YAC7D,OAAO,CAAC,KAAK,CAAC,OAAO,CAAC,IAAI,CAAC,GAAG,EAAE,CAAA;YAChC,IAAM,YAAY,GAAG,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,CAAA;;YAGxC,MAAM,CAAC,IAAI,CAAC,YAAY,CAAC,CAAC,OAAO,CAAC,UAAC,MAAc;gBAChD,IAAI,KAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,CAAC,MAAM,CAAC,CAAC,QAAQ,KAAK,IAAI,EAAE;oBAClD,OAAM;iBACN;gBAED,QAAQ,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC,MAAM,CAAC,GAAG,CAAC,CAAA;gBAClC,OAAO,CAAC,KAAK,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC,MAAM,CAAC,GAAG,SAAS,CAC9C,QAAQ,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC,MAAM,CAAC,CAC9B,CAAA;gBAED,IAAM,UAAU,GAAM,IAAI,SAAI,MAAQ,CAAA;;gBAGtC,IAAI,MAAM,CAAC,SAAS,IAAI,CAAC,MAAM,CAAC,SAAS,CAAC,QAAQ,CAAC,UAAU,CAAC,EAAE;oBAC/D,OAAM;iBACN;;gBAGD,IAAI,MAAM,CAAC,SAAS,IAAI,MAAM,CAAC,SAAS,CAAC,QAAQ,CAAC,UAAU,CAAC,EAAE;oBAC9D,OAAM;iBACN;;gBAGD,IAAM,UAAU,GAAG,KAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,CAAC,MAAM,CAAC,CAAA;;gBAG9C,IAAM,aAAa,GAAG;oBAAO,eAAQ;yBAAR,UAAQ,EAAR,qBAAQ,EAAR,IAAQ;wBAAR,0BAAQ;;;;;;;;oCAEnC,IAAI,CAAC,QAAQ,CAAC,OAAO,CAAC,IAAI,CAAC,EAAE,IAAI,MAAA,EAAE,MAAM,QAAA,EAAE,CAAC,CAAA;oCAEvB,qBAAM,UAAU,eAAI,KAAK,GAAC;;oCAAzC,YAAY,GAAG,SAA0B;oCAC/C,IAAI,CAAC,QAAQ,CAAC,OAAO,CAAC,IAAI,CAAC,EAAE,IAAI,MAAA,EAAE,MAAM,QAAA,EAAE,CAAC,CAAA;oCAC5C,sBAAO,YAAY,EAAA;;;oCAEnB,IAAI,CAAC,QAAQ,CAAC,OAAO,CAAC,IAAI,CAAC,EAAE,IAAI,MAAA,EAAE,MAAM,QAAA,EAAE,CAAC,CAAA;oCAC5C,MAAM,OAAK,CAAA;;;;;iBAEZ,CAAA;gBAED,aAAa,CAAC,QAAQ,GAAG,IAAI,CAAA;;gBAG7B,KAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,CAAC,MAAM,CAAC,GAAG,aAAa,CAAA;aAC3C,CAAC,CAAA;SACF;KACD,CAAA;CACD,EAAA;;;;"}